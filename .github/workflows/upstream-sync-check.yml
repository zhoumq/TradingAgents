name: ä¸Šæ¸¸åŒæ­¥æ£€æŸ¥

on:
  schedule:
    # æ¯å‘¨ä¸€ä¸Šåˆ9ç‚¹æ£€æŸ¥ä¸Šæ¸¸æ›´æ–°
    - cron: '0 9 * * 1'
  workflow_dispatch:
    # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      force_sync:
        description: 'å¼ºåˆ¶åŒæ­¥ï¼ˆè·³è¿‡ç¡®è®¤ï¼‰'
        required: false
        default: 'false'
        type: boolean

jobs:
  check-upstream:
    runs-on: ubuntu-latest
    name: æ£€æŸ¥ä¸Šæ¸¸æ›´æ–°
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install requests
    
    - name: é…ç½®Git
      run: |
        git config --global user.name 'GitHub Actions'
        git config --global user.email 'actions@github.com'
    
    - name: æ·»åŠ ä¸Šæ¸¸ä»“åº“
      run: |
        git remote add upstream https://github.com/TauricResearch/TradingAgents.git || true
        git fetch upstream
    
    - name: æ£€æŸ¥ä¸Šæ¸¸æ›´æ–°
      id: check_updates
      run: |
        # è·å–ä¸Šæ¸¸æ–°æäº¤æ•°é‡
        NEW_COMMITS=$(git rev-list --count HEAD..upstream/main)
        echo "new_commits=$NEW_COMMITS" >> $GITHUB_OUTPUT
        
        if [ "$NEW_COMMITS" -gt 0 ]; then
          echo "has_updates=true" >> $GITHUB_OUTPUT
          echo "å‘ç° $NEW_COMMITS ä¸ªæ–°æäº¤"
          
          # è·å–æœ€æ–°æäº¤ä¿¡æ¯
          git log --oneline --no-merges HEAD..upstream/main | head -10 > recent_commits.txt
          echo "recent_commits<<EOF" >> $GITHUB_OUTPUT
          cat recent_commits.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        else
          echo "has_updates=false" >> $GITHUB_OUTPUT
          echo "æ²¡æœ‰æ–°çš„ä¸Šæ¸¸æ›´æ–°"
        fi
    
    - name: åˆ†ææ›´æ–°ç±»å‹
      if: steps.check_updates.outputs.has_updates == 'true'
      id: analyze_updates
      run: |
        # åˆ†ææäº¤ç±»å‹
        FEATURES=$(git log --oneline --no-merges HEAD..upstream/main | grep -i -E "(feat|feature|add)" | wc -l)
        FIXES=$(git log --oneline --no-merges HEAD..upstream/main | grep -i -E "(fix|bug|patch)" | wc -l)
        DOCS=$(git log --oneline --no-merges HEAD..upstream/main | grep -i -E "(doc|readme)" | wc -l)
        
        echo "features=$FEATURES" >> $GITHUB_OUTPUT
        echo "fixes=$FIXES" >> $GITHUB_OUTPUT
        echo "docs=$DOCS" >> $GITHUB_OUTPUT
        
        # åˆ¤æ–­æ›´æ–°ä¼˜å…ˆçº§
        if [ "$FIXES" -gt 0 ]; then
          echo "priority=high" >> $GITHUB_OUTPUT
          echo "reason=åŒ…å«Bugä¿®å¤" >> $GITHUB_OUTPUT
        elif [ "$FEATURES" -gt 2 ]; then
          echo "priority=medium" >> $GITHUB_OUTPUT
          echo "reason=åŒ…å«å¤šä¸ªæ–°åŠŸèƒ½" >> $GITHUB_OUTPUT
        else
          echo "priority=low" >> $GITHUB_OUTPUT
          echo "reason=å¸¸è§„æ›´æ–°" >> $GITHUB_OUTPUT
        fi
    
    - name: åˆ›å»ºIssueæŠ¥å‘Š
      if: steps.check_updates.outputs.has_updates == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const newCommits = '${{ steps.check_updates.outputs.new_commits }}';
          const recentCommits = `${{ steps.check_updates.outputs.recent_commits }}`;
          const features = '${{ steps.analyze_updates.outputs.features }}';
          const fixes = '${{ steps.analyze_updates.outputs.fixes }}';
          const docs = '${{ steps.analyze_updates.outputs.docs }}';
          const priority = '${{ steps.analyze_updates.outputs.priority }}';
          const reason = '${{ steps.analyze_updates.outputs.reason }}';
          
          const issueTitle = `ğŸ”„ ä¸Šæ¸¸æ›´æ–°æ£€æµ‹ - ${newCommits} ä¸ªæ–°æäº¤`;
          const issueBody = `
          ## ğŸ“Š æ›´æ–°æ¦‚è§ˆ
          
          - **æ–°æäº¤æ•°é‡**: ${newCommits}
          - **æ›´æ–°ä¼˜å…ˆçº§**: ${priority.toUpperCase()}
          - **ä¼˜å…ˆçº§åŸå› **: ${reason}
          
          ## ğŸ“ˆ æ›´æ–°åˆ†æ
          
          - ğŸ†• æ–°åŠŸèƒ½: ${features} ä¸ª
          - ğŸ› Bugä¿®å¤: ${fixes} ä¸ª  
          - ğŸ“š æ–‡æ¡£æ›´æ–°: ${docs} ä¸ª
          
          ## ğŸ“‹ æœ€è¿‘æäº¤
          
          \`\`\`
          ${recentCommits}
          \`\`\`
          
          ## ğŸ¯ å»ºè®®è¡ŒåŠ¨
          
          ${priority === 'high' ? 
            'âš ï¸ **å»ºè®®ç«‹å³åŒæ­¥** - åŒ…å«é‡è¦çš„Bugä¿®å¤' : 
            priority === 'medium' ? 
            'ğŸ“… **å»ºè®®æœ¬å‘¨å†…åŒæ­¥** - åŒ…å«æœ‰ä»·å€¼çš„æ–°åŠŸèƒ½' : 
            'ğŸ“ **å¯ä»¥è®¡åˆ’åŒæ­¥** - å¸¸è§„æ›´æ–°ï¼Œå¯ä»¥å®‰æ’æ—¶é—´åŒæ­¥'
          }
          
          ## ğŸ”§ åŒæ­¥æ­¥éª¤
          
          1. æ£€æŸ¥å½“å‰å·¥ä½œçŠ¶æ€
          2. è¿è¡ŒåŒæ­¥è„šæœ¬: \`python scripts/sync_upstream.py\`
          3. è§£å†³å¯èƒ½çš„å†²çª
          4. æµ‹è¯•åŠŸèƒ½å®Œæ•´æ€§
          5. æ›´æ–°ç›¸å…³æ–‡æ¡£
          
          ## ğŸ“ ç›¸å…³é“¾æ¥
          
          - [ä¸Šæ¸¸ä»“åº“](https://github.com/TauricResearch/TradingAgents)
          - [åŒæ­¥ç­–ç•¥æ–‡æ¡£](docs/maintenance/upstream-sync.md)
          - [åŒæ­¥è„šæœ¬](scripts/sync_upstream.py)
          
          ---
          
          *æ­¤Issueç”±GitHub Actionsè‡ªåŠ¨åˆ›å»ºäº ${new Date().toISOString()}*
          `;
          
          // æ£€æŸ¥æ˜¯å¦å·²æœ‰ç›¸ä¼¼çš„Issue
          const existingIssues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open',
            labels: 'upstream-sync'
          });
          
          const hasOpenSyncIssue = existingIssues.data.some(issue => 
            issue.title.includes('ä¸Šæ¸¸æ›´æ–°æ£€æµ‹')
          );
          
          if (!hasOpenSyncIssue) {
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: issueTitle,
              body: issueBody,
              labels: ['upstream-sync', priority === 'high' ? 'priority-high' : priority === 'medium' ? 'priority-medium' : 'priority-low']
            });
            
            console.log('âœ… å·²åˆ›å»ºä¸Šæ¸¸æ›´æ–°Issue');
          } else {
            console.log('â„¹ï¸ å·²å­˜åœ¨å¼€æ”¾çš„åŒæ­¥Issueï¼Œè·³è¿‡åˆ›å»º');
          }
    
    - name: å‘é€é€šçŸ¥
      if: steps.check_updates.outputs.has_updates == 'true'
      run: |
        echo "ğŸ“§ ä¸Šæ¸¸æ›´æ–°é€šçŸ¥å·²å‘é€"
        echo "- æ–°æäº¤æ•°é‡: ${{ steps.check_updates.outputs.new_commits }}"
        echo "- æ›´æ–°ä¼˜å…ˆçº§: ${{ steps.analyze_updates.outputs.priority }}"
        echo "- å·²åˆ›å»ºIssueè¿›è¡Œè·Ÿè¸ª"

  auto-sync:
    runs-on: ubuntu-latest
    name: è‡ªåŠ¨åŒæ­¥ï¼ˆä»…é™ä½é£é™©æ›´æ–°ï¼‰
    needs: check-upstream
    if: github.event.inputs.force_sync == 'true' || (needs.check-upstream.outputs.priority == 'low' && needs.check-upstream.outputs.fixes == '0')
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: é…ç½®Git
      run: |
        git config --global user.name 'GitHub Actions Bot'
        git config --global user.email 'actions@github.com'
    
    - name: æ·»åŠ ä¸Šæ¸¸ä»“åº“
      run: |
        git remote add upstream https://github.com/TauricResearch/TradingAgents.git
        git fetch upstream
    
    - name: æ‰§è¡Œè‡ªåŠ¨åŒæ­¥
      run: |
        python scripts/sync_upstream.py --auto
    
    - name: æ¨é€æ›´æ–°
      run: |
        git push origin main
    
    - name: åˆ›å»ºåŒæ­¥æŠ¥å‘Š
      uses: actions/github-script@v7
      with:
        script: |
          const reportTitle = 'ğŸ¤– è‡ªåŠ¨åŒæ­¥å®Œæˆ';
          const reportBody = `
          ## âœ… è‡ªåŠ¨åŒæ­¥æˆåŠŸ
          
          GitHub Actions å·²è‡ªåŠ¨å®Œæˆä¸Šæ¸¸åŒæ­¥ã€‚
          
          **åŒæ­¥æ—¶é—´**: ${new Date().toISOString()}
          **è§¦å‘æ–¹å¼**: ${context.eventName === 'workflow_dispatch' ? 'æ‰‹åŠ¨è§¦å‘' : 'è‡ªåŠ¨è§¦å‘'}
          
          ## ğŸ“‹ åç»­å»ºè®®
          
          1. æ£€æŸ¥åŒæ­¥çš„æ›´æ”¹æ˜¯å¦æ­£å¸¸
          2. è¿è¡Œæœ¬åœ°æµ‹è¯•éªŒè¯åŠŸèƒ½
          3. æ›´æ–°ç›¸å…³æ–‡æ¡£ï¼ˆå¦‚éœ€è¦ï¼‰
          
          ---
          
          *æ­¤æŠ¥å‘Šç”±GitHub Actionsè‡ªåŠ¨ç”Ÿæˆ*
          `;
          
          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: reportTitle,
            body: reportBody,
            labels: ['upstream-sync', 'auto-sync']
          });
